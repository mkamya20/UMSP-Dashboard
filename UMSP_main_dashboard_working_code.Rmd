---
title: "UMSP Current Dashboard Code"
author: "Shakira Babirye"
date: "2025-03-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




```{r}

rm(list = ls(all.names = TRUE)) #clear all objects including hidden objects.

```



```{r}

setwd("E:/bbrsh/Desktop/Shakira/IDRC/Projects/UMSP dashboards/working_final_dashboard")

```




```{r}


library(shiny)  
library(shinythemes)  
library(bslib)  
library(fpp3)  
library(tsibble)  
library(readr)  
library(tidyverse)  
library(plotly)  
library(magrittr)  
library(DT)  
library(readstata13) 
library(ggplot2)  
library(dplyr)  
library(plotly)  
library(bslib)  
library(shinydashboard)  
library(gtsummary)  
library(rlang)  
library(gt)  
library(officer)  
library(forecast)
library(tseries)

# Define an enhanced custom theme  
custom_theme <- bs_theme(  
  version = 5,  
  bg = "#1E3A67",  
  fg = "#FFFFFF",  
  primary = "#F7A800",  
  secondary = "#6A7F98",  
  success = "#28A745",  
  info = "#17A2B8",  
  warning = "#FFC107",  
  danger = "#DC3545",  
  base_font = font_google("Open Sans"),  
  heading_font = font_google("Lora"),  
  code_font = font_google("Source Code Pro")  
)  



# Load the saved .RData file
load("UMSP_data.RData")


# Select relevant columns  
UMSP_data2 <- UMSP_data %>% dplyr::select(monthyear, site, Region, malinc, propsuspected, TPR)  

# Convert each dataset into tsibble format  
malinc <- UMSP_data2 %>%   
  dplyr::select(monthyear, malinc) %>%  
  mutate(DATE = yearmonth(monthyear),   
         malaria_incidence = malinc) %>%  
  group_by(DATE) %>%  
  summarise(malaria_incidence = mean(malaria_incidence, na.rm = TRUE)) %>%  
  as_tsibble(index = DATE)  

propsuspected <- UMSP_data2 %>%   
  dplyr::select(monthyear, propsuspected) %>%  
  mutate(DATE = yearmonth(monthyear),   
         suspected_malaria_cases = propsuspected) %>%  
  group_by(DATE) %>%  
  summarise(suspected_malaria_cases = mean(suspected_malaria_cases, na.rm = TRUE)) %>%  
  as_tsibble(index = DATE)  

TPR <- UMSP_data2 %>%   
  dplyr::select(monthyear, TPR) %>%  
  mutate(DATE = yearmonth(monthyear)) %>%  
  group_by(DATE) %>%  
  summarise(TPR = mean(TPR, na.rm = TRUE)) %>%  
  as_tsibble(index = DATE)  



# Preprocess data  
UMSP_data$monthyear <- as.Date(UMSP_data$monthyear)    
UMSP_data$Region <- trimws(UMSP_data$Region)    

UMSP_data <- UMSP_data %>%  
  rename(  
    Malaria_Incidence = malinc,  
    Total_Positive_Rate = TPR,  
    Proportion_Suspected_to_Have_Malaria = propsuspected  
  ) %>%  
  mutate(  
    Year = format(monthyear, "%Y"),   
    Month = as.numeric(format(monthyear, "%m")),    
    MonthName = format(monthyear, "%B"),   
    MonthYearFormatted = format(monthyear, "%B %Y")    
  ) %>%  
  mutate(NEWsiteID = as.character(NEWsiteID))  


# UI
ui <- fluidPage(
  theme = custom_theme,
  titlePanel("IDRC Malaria Dashboard & Forecasting"),
  br(),
  h5("Author: IDRC Data Science Working Group"),
  br(),
  
  sidebarLayout(
    sidebarPanel(
      style = "background-color: #2E3A87; color: white; padding: 15px; border-radius: 10px;",
      
      # Forecasting Section
      h4("Forecasting Inputs"),
      selectInput("dataset", "Column to forecast:", 
                  choices = list("Malaria Incidence" = "malinc", 
                                 "Proportion Suspected to Have Malaria" = "propsuspected", 
                                 "Total Positive Rate" = "TPR")),
      numericInput("ahead", "Years to Forecast Ahead:", 2),
      
      # Update Button
      submitButton("Update View"),
      
      br(), # Add spacing between sections

      # Data Distribution Section
      h4("Data Distribution Inputs"),
      selectInput("column", "Select Column to Visualize:", 
                  choices = c("Malaria_Incidence", "Total_Positive_Rate", "Proportion_Suspected_to_Have_Malaria"),
                  selected = "Malaria_Incidence"),
      selectInput("region", "Select Region(s):", 
                  choices = c("All Regions", unique(UMSP_data$Region)),
                  selected = "All Regions", multiple = TRUE),
      selectInput("site", "Select Study Site(s):", 
                  choices = c("All Sites", unique(UMSP_data$NEWsiteID)),
                  selected = "All Sites", multiple = TRUE),
      selectInput("year", "Select Year(s):", 
                  choices = c("All Years", unique(UMSP_data$Year)),
                  selected = "All Years", multiple = TRUE),
      selectInput("month", "Select Month(s):", 
                  choices = c("All Months", "January", "February", "March", "April", "May", "June", "July", 
                              "August", "September", "October", "November", "December"),
                  selected = "All Months", multiple = TRUE),
      selectInput("plotType", "Select Plot Type:", 
                  choices = c("Line Plot" = "line", "Bar Graph" = "bar", "Heatmap" = "heatmap"), 
                  selected = "line"),
      selectInput("summaryPlotType", "Select Summary Plot Type:", 
                  choices = c("Box Plot" = "box", "Violin Plot" = "violin"), 
                  selected = "box"),
      
      br(), # Add spacing between sections

      # Download Buttons
      downloadButton("downloadPlot", "Download Dashboard Plot"),
      downloadButton("downloadSummaryPlot", "Download Summary Plot"),
      downloadButton("downloadSummaryTables", "Download Summary Tables as Word")
    ),
    
    mainPanel(
      style = "background-color: #F1F1F1; padding: 15px; border-radius: 10px;",
      
      tabsetPanel(
        tabPanel("Dataset & Forecasting",
                 h3(textOutput("caption")),
                 plotOutput("ForecastPlot"),
                 plotOutput("dcompPlot"),
                 plotOutput("residuals")),
        
        tabPanel("Dashboard & Summary Statistics",
                 plotlyOutput("plotOutput"),
                 gt_output("summaryTableRegion"),
                 gt_output("summaryTableYear")),
        
        tabPanel("Summary Statistics Visualizations",
                 plotlyOutput("summaryPlot"),
                 plotOutput("forecastPlot"))
      )
    )
  )
)


# Sever
server <- function(input, output, session) {
  
  # Reactive function to get the selected dataset for the first part
  getDataset <- reactive({
    if (input$dataset == "malinc") return(malinc)
    if (input$dataset == "propsuspected") return(propsuspected)
    return(TPR)
  })

  # Reactive function to get the selected column name for the first part
  getColumn <- reactive({
    if (input$dataset == "malinc") return("malaria_incidence")
    if (input$dataset == "propsuspected") return("suspected_malaria_cases")
    return("TPR")
  })

  # Reactive function to get the filtered data for the second part
  filtered_data <- reactive({
    data <- UMSP_data
    if (!"All Regions" %in% input$region) {
      data <- data %>% filter(Region %in% input$region)
    }
    if (!"All Sites" %in% input$site) {
      data <- data %>% filter(NEWsiteID %in% input$site)
    }
    if (!"All Years" %in% input$year) {
      data <- data %>% filter(Year %in% input$year)
    }
    if (!"All Months" %in% input$month) {
      data <- data %>% filter(MonthName %in% input$month)
    }
    return(data)
  })
  
  # Caption for the dataset (first part)
  output$caption <- renderText({
    paste("Dataset: ", input$dataset)
  })

  # Time Series Decomposition Plot (first part)
  output$dcompPlot <- renderPlot({
    dataset <- getDataset()
    column <- getColumn()
    
    dataset %>%
      model(STL(!!sym(column) ~ season(window = Inf))) %>%
      components() %>%
      autoplot()
  })

  # Forecasting Plot (first part)
  output$ForecastPlot <- renderPlot({
    dataset <- getDataset()
    column <- getColumn()
    
    dataset %>%
      model(ETS = ETS(!!sym(column)),
            ARIMA = ARIMA(!!sym(column))) %>%
      forecast(h = input$ahead * 12, level = 0.95) %>%
      autoplot(dataset) +
      labs(title = paste0(input$ahead, " Year Forecast for ", input$dataset),
           y = column,
           x = "Date") +
      theme_light()
  })
  
  # Residual Diagnostics Plot (first part)
  output$residuals <- renderPlot({
    dataset <- getDataset()
    column <- getColumn()
    
    dataset %>%
      model(ETS(!!sym(column))) %>%
      gg_tsresiduals() + 
      labs(title = "Residual Diagnostics")
  })

  # Plot Output (second part)
  output$plotOutput <- renderPlotly({
    data <- filtered_data()
    # Remove duplicates based on Region and monthyear to ensure no duplicate hover info
    data_unique <- data

    if (input$plotType == "heatmap") {
      # Prepare data for heatmap
      heatmap_data <- data_unique %>%
        group_by(Year, Region) %>%
        summarise(value = mean(.data[[input$column]], na.rm = TRUE)) %>%
        mutate(
          hover_text = paste("Region:", Region, "<br>Year:", Year, "<br>Value:", round(value, 2))
        )

      # Create heatmap with hover text
      plot <- ggplot(heatmap_data, aes(x = Year, y = Region, fill = value, text = hover_text)) +
        geom_tile() +
        scale_fill_gradient(low = "white", high = "#F7A800") +
        labs(title = paste(input$column, "Heatmap"),
             x = "Year",
             y = "Region") +
        theme_minimal() +
        theme(
          legend.position = "bottom",
          axis.text.x = element_text(angle = 45, hjust = 1)
        )

      # Convert to plotly with hover text
      ggplotly(plot, tooltip = "text")
    } else {
      # For Line Plot and Bar Plot
      # Add hover text for line/bar plots
      data_unique <- data_unique %>%
        mutate(
          hover_text = paste("Region:", Region, "<br>Date:", monthyear, "<br>Value:", round(.data[[input$column]], 2))
        )

      plot <- ggplot(data_unique, aes(x = monthyear, y = .data[[input$column]], group = Region, color = Region, text = hover_text))

      if (input$plotType == "line") {
        plot <- plot + geom_line(size = 0.8) + geom_point(size = 0.5)
      } else if (input$plotType == "bar") {
        plot <- plot + geom_bar(stat = "identity", position = "dodge", aes(fill = Region))
      }

      plot <- plot +
        labs(title = paste(input$column, "Trend by Region and Year"), x = "Year", y = input$column) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

      # Convert to plotly with hover text
      ggplotly(plot, tooltip = "text")
    }
  })

  # Summary Plot (second part)
  output$summaryPlot <- renderPlotly({
    data <- filtered_data()
    plot <- ggplot(data, aes(x = Region, y = .data[[input$column]], fill = Region))

    if (input$summaryPlotType == "box") {
      plot <- plot + geom_boxplot()
    } else if (input$summaryPlotType == "violin") {
      plot <- plot + geom_violin()
    }

    plot <- plot +
      labs(title = paste(input$column, "Summary by Region"), x = "Region", y = input$column) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

    return(ggplotly(plot))
  })

  # Summary Statistics Table by Region (second part)
  output$summaryTableRegion <- render_gt({
    data <- filtered_data()
    col_name <- sym(input$column)
    summary_table_region <- data %>%
      dplyr::select(!!col_name, Region) %>%
      tbl_summary(by = Region, statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"), missing = "no") %>%
      add_p() %>%
      add_overall() %>%
      as_gt() %>%
      gt::tab_header(title = paste(input$column, "by Region"))
    
    summary_table_region
  })

  # Summary Statistics Table by Year (second part)
  output$summaryTableYear <- render_gt({
    data <- filtered_data()
    col_name <- sym(input$column)
    summary_table_year <- data %>%
      dplyr::select(!!col_name, Year) %>%
      tbl_summary(by = Year, statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"), missing = "no") %>%
      add_p() %>%
      add_overall() %>%
      as_gt() %>%
      gt::tab_header(title = paste(input$column, "by Year"))
    
    summary_table_year
  })


  # Download Dashboard Plot
  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Dashboard_Plot_", Sys.Date(), ".png", sep = "")
    },
    content = function(file) {
      data <- filtered_data()
      plot <- ggplot(data, aes(x = monthyear, y = .data[[input$column]], group = Region, color = Region)) +
        geom_line(size = 1.2) + geom_point(size = 2) +
        labs(title = paste(input$column, "Trend by Region"), x = "Year", y = input$column)
      ggsave(file, plot, width = 10, height = 6)
    }
  )

  # Download Summary Plot
  output$downloadSummaryPlot <- downloadHandler(
    filename = function() {
      paste("Summary_Plot_", Sys.Date(), ".png", sep = "")
    },
    content = function(file) {
      data <- filtered_data()
      plot <- ggplot(data, aes(x = Region, y = .data[[input$column]], fill = Region)) +
        geom_boxplot() +
        labs(title = paste(input$column, "Summary by Region"), x = "Region", y = input$column)
      ggsave(file, plot, width = 10, height = 6)
    }
  )

  # Download Summary Tables as Word
  output$downloadSummaryTables <- downloadHandler(
    filename = function() {
      paste("Summary_Tables_", Sys.Date(), ".docx", sep = "")
    },
    content = function(file) {
      data <- filtered_data()
      col_name <- sym(input$column)

      # Create tables
      table_region <- data %>%
        dplyr::select(!!col_name, Region) %>%
        tbl_summary(by = Region, statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"), missing = "no") %>%
        add_p() %>%
        add_overall()

      table_year <- data %>%
        dplyr::select(!!col_name, Year) %>%
        tbl_summary(by = Year, statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"), missing = "no") %>%
        add_p() %>%
        add_overall()

      # Export tables to Word
      doc <- read_docx() %>%
        body_add_gt(gt_table = table_region, align = "center") %>%
        body_add_gt(gt_table = table_year, align = "center")
      
      print(doc, target = file)
    }
  )
}


# Run the application
shinyApp(ui = ui, server = server)



```





























