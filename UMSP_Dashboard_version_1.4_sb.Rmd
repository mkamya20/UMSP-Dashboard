---
title: "UMSP Dashboard"
author: "UMSP Dashboard team builders (Moses, Isaiah, Eric and Shakira)"
date: "2025-02-19"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Clear everything from the environment

```{r}

rm(list = ls(all.names = TRUE)) #clear all objects including hidden objects.

```


```


## Set working directory

```{r}

setwd("E:/bbrsh/Desktop/Shakira/IDRC/Projects/UMSP dashboards")

```

```{r}
install.packages("gtsummary")
```

```{r}
install.packages("Cairo")

```

```{r}

# Libraries needed  
library(shiny)  
library(ggplot2)  
library(dplyr)  
library(plotly)  
library(bslib)  
library(shinydashboard)  
library(DT)  
library(gtsummary)  
library(rlang)  
library(haven)  
library(readstata13)  
library(gt)
library(Cairo)

# Load data  
UMSP_data <- read.dta13("E:/bbrsh/Desktop/Shakira/IDRC/Projects/UMSP dashboards/Monthly data for all sites through December 2024.dta",   
                         convert.factors = TRUE, generate.factors = TRUE,  
                         encoding = "UTF-8", fromEncoding = NULL, convert.underscore = FALSE,  
                         missing.type = TRUE, convert.dates = TRUE, replace.strl = TRUE,  
                         add.rownames = FALSE, nonint.factors = TRUE, select.rows = NULL,  
                         select.cols = NULL, strlexport = FALSE, strlpath = ".")  

# Preprocess data  
UMSP_data$monthyear <- as.Date(UMSP_data$monthyear)  # Ensure it's in Date format  
UMSP_data$Region <- trimws(UMSP_data$Region)  # Remove extra spaces  

UMSP_data <- UMSP_data %>%  
  rename(  
    `Malaria Incidence` = malinc,  
    `Total Positive Rate` = TPR,  
    `Proportion Suspected to Have Malaria` = propsuspected  
  ) %>%  
  mutate(  
    Year = format(monthyear, "%Y"),  # Extract Year  
    MonthYearFormatted = format(monthyear, "%B %Y")  # Month + Year for Hover  
  )  

# Define an enhanced custom theme  
custom_theme <- bs_theme(  
  version = 5,  # Use Bootstrap 5  
  bg = "#8E3A67",  # A soft blue background for professionalism  
  fg = "#FFFFFF",  # Light text for readability  
  primary = "#F7A800",  # IDRC gold for primary elements  
  secondary = "#6A7F98",  # Muted secondary color (grayish blue)  
  success = "#28A745",  # Success green  
  info = "#17A2B8",  # Info blue  
  warning = "#FFC107",  # Warning yellow  
  danger = "#DC3545",  # Danger red  
  base_font = font_google("Open Sans"),  # Clean Google Font for readability  
  heading_font = font_google("Lora"),  # Stylish heading font  
  code_font = font_google("Source Code Pro")  # Font for code-like text  
)  

# Update UI to include heatmap option  
ui <- fluidPage(  
  theme = custom_theme,  
  titlePanel("Malaria Dashboard"),  
  sidebarLayout(  
    sidebarPanel(  
      style = "background-color: #2E3A87; color: white; padding: 15px; border-radius: 10px;",  
      selectInput("column", "Select Column to Visualize:",  
                  choices = c("Malaria Incidence", "Total Positive Rate", "Proportion Suspected to Have Malaria"),  
                  selected = "Malaria Incidence"),  
      selectInput("region", "Select Region(s):",  
                  choices = c("All Regions", unique(UMSP_data$Region)),  
                  selected = "All Regions",  
                  multiple = TRUE),
      selectInput("site", "Select Site(s):",
            choices = c("All Sites", unique(UMSP_data$site)),
            selected = "All Sites",
            multiple = TRUE),
      selectInput("year", "Select Year(s):",  
                  choices = c("All Years", unique(UMSP_data$Year)),  
                  selected = "All Years",  
                  multiple = TRUE),  
      selectInput("plotType", "Select Plot Type:",  
                  choices = c("Line Plot" = "line", "Bar Graph" = "bar", "Heatmap" = "heatmap"),  
                  selected = "line"),  
      downloadButton("downloadPlot", "Download Plot")  
    ),  
    mainPanel(  
      style = "background-color: #F1F1F1; padding: 15px; border-radius: 10px;",  
      tabsetPanel(  
        tabPanel("Dashboard", plotlyOutput("plotOutput")),  
        tabPanel("Summary Statistics", gt_output("summaryTableRegion"), gt_output("summaryTableYear"))  
      )  
    )  
  )  
)  

# Server logic  
server <- function(input, output) {  
  filtered_data <- reactive({  
    data <- UMSP_data  
    if (!"All Regions" %in% input$region) {  
      data <- data %>% filter(Region %in% input$region)  
    }
     if (!"All Sites" %in% input$site) {  
    data <- data %>% filter(Site %in% input$site)  
  } 
    if (!"All Years" %in% input$year) {  
      data <- data %>% filter(Year %in% input$year)  
    }  
    return(data)  
  })  
  
  output$plotOutput <- renderPlotly({  
    data <- filtered_data()  
    
    if (input$plotType == "heatmap") {  
      # Prepare data for heatmap  
      heatmap_data <- data %>%  
        group_by(Year, Region) %>%  
        summarise(value = mean(.data[[input$column]])) %>%  
        mutate(  
          hover_text = paste("Region:", Region, "<br>Year:", Year, "<br>Value:", round(value, 2))  
        )  
      
      # Create heatmap with hover text  
      plot <- ggplot(heatmap_data, aes(x = Year, y = Region, fill = value)) +  
        geom_tile() +  
        scale_fill_gradient(low = "white", high = "#F7A800") +  # Gold gradient for heatmap  
        labs(title = paste(input$column, "Heatmap"),  
             x = "Year",  
             y = "Region") +  
        theme_minimal() +  
        theme(  
          legend.position = "bottom",  
          axis.text.x = element_text(angle = 45, hjust = 1)  
        ) +  
        aes(text = hover_text)  
      
      # Convert to plotly with custom tooltip  
      plotly_plot <- ggplotly(plot, tooltip = "text") %>%  
        layout(  
          hoverlabel = list(  
            bgcolor = "#2E3A87",  # Background color of tooltip  
            border = "0",            # Remove border  
            font = list(  
              color = "white",        # Text color  
              size = 14              # Font size  
            )  
          )  
        )  
      
      return(plotly_plot)  
    } else {  
      # Create regular plot  
      plot <- ggplot(data, aes(x = monthyear, y = .data[[input$column]], group = Region, color = Region,  
                         text = paste("Region:", Region, "<br>Month-Year:", MonthYearFormatted,  
                                      "<br>Value:", round(.data[[input$column]], 2))))   
  
   
      
      if (input$plotType == "line") {  
        plot <- plot + geom_line(size = 1.2) + geom_point(size = 2)  
      } else if (input$plotType == "bar") {  
        plot <- plot + geom_bar(stat = "identity", position = "dodge", aes(fill = Region))  
      }  
      
      plot <- plot +   
        labs(  
          title = paste(input$column, "Trend by Region and Year"),  
          x = "Year",  
          y = input$column  
        ) +  
        scale_x_date(date_breaks = "1 year", date_labels = "%Y") +  
        theme(  
          axis.text.x = element_text(angle = 45, hjust = 1),  
          legend.title = element_blank(),  
          legend.position = "bottom"  
        )  
      
      return(ggplotly(plot, tooltip = "text"))  
    }  
  })  
  
  # Summary Statistics Table by Region  
  output$summaryTableRegion <- render_gt({  
    data <- filtered_data()  
    col_name <- sym(input$column)  
    summary_table_region <- data %>%  
      select(!!col_name, Region) %>%  
      tbl_summary(by = Region, statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"), missing = "no") %>%  
      add_p() %>%  
      add_overall() %>%  
      as_gt() %>%  
      gt::tab_header(title = paste(input$column, "by Region"))  
    
    summary_table_region  
  })  
  
  # Summary Statistics Table by Year  
  output$summaryTableYear <- render_gt({  
    data <- filtered_data()  
    col_name <- sym(input$column)  
    summary_table_year <- data %>%  
      select(!!col_name, Year) %>%  
      tbl_summary(by = Year, statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"), missing = "no") %>%  
      add_p() %>%  
      add_overall() %>%  
      as_gt() %>%  
      gt::tab_header(title = paste(input$column, "by Year"))  
    
    summary_table_year  
  })  
  
  # Download Plot  
  output$downloadPlot <- downloadHandler(  
    filename = function() {  
        paste("Malaria_Trend_Plot", Sys.Date(), ".png", sep = "")  
    },  
    content = function(file) {  
        data <- filtered_data()  
        
        if (input$plotType == "heatmap") {  
            heatmap_data <- data %>%  
                group_by(Year, Region) %>%  
                summarise(value = mean(.data[[input$column]])) %>%  
                mutate(  
                    hover_text = paste("Region:", Region, "<br>Year:", Year, "<br>Value:", round(value, 2))  
                )  
            
            plot <- ggplot(heatmap_data, aes(x = Year, y = Region, fill = value)) +  
                geom_tile() +  
                scale_fill_gradient(low = "white", high = "#F7A800") +  
                labs(title = paste(input$column, "Heatmap"),  
                     x = "Year",  
                     y = "Region") +  
                theme_minimal() +  
                theme(  
                    legend.position = "bottom",  
                    axis.text.x = element_text(angle = 45, hjust = 1)  
                ) +  
                aes(text = hover_text)  
        } else {  
            plot <- ggplot(data, aes(x = monthyear, y = .data[[input$column]], group = Region, color = Region)) +  
                geom_line(size = 1.2) + geom_point(size = 2) +  
                labs(title = paste(input$column, "Trend by Region"),  
                     x = "Year",  
                     y = input$column)  
        }  
        
        ggsave(file, plot, width = 10, height = 6)  
    }  
  )  
}  

shinyApp(ui = ui, server = server)  


```










